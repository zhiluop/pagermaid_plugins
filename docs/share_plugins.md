# åˆ†äº«æ’ä»¶ (SharePlugins)

## åŠŸèƒ½æ¦‚è¿°

å°†æ’ä»¶ç›®å½•ä¸­çš„æ’ä»¶ä»¥æ–‡ä»¶å½¢å¼åˆ†äº«åˆ° Telegram ç¾¤ç»„ã€‚æ”¯æŒæŸ¥çœ‹æ’ä»¶åˆ—è¡¨ã€é€šè¿‡åºå·é€‰æ‹©æ’ä»¶ï¼Œå¹¶åœ¨å‘é€æ–‡ä»¶å‰è‡ªåŠ¨æ’¤å›æ“ä½œæ¶ˆæ¯ï¼Œç¡®ä¿ç¾¤ç»„æ¶ˆæ¯æ•´æ´ã€‚

## æ–‡ä»¶ç»“æ„

```
plugins/
â””â”€â”€ share_plugins.py         # åˆ†äº«æ’ä»¶ä¸»æ–‡ä»¶
```

## åŠŸèƒ½ä»‹ç»

- **æ’ä»¶åˆ—è¡¨æŸ¥çœ‹**ï¼šåˆ—å‡º plugins ç›®å½•ä¸‹æ‰€æœ‰ Python æ’ä»¶æ–‡ä»¶
- **åºå·é€‰æ‹©**ï¼šé€šè¿‡è¾“å…¥åºå·å¿«é€Ÿé€‰æ‹©è¦åˆ†äº«çš„æ’ä»¶
- **æ¶ˆæ¯è‡ªåŠ¨æ’¤å›**ï¼šå‘é€æ’ä»¶æ–‡ä»¶å‰æ’¤å›æ“ä½œæ¶ˆæ¯ï¼Œä¿æŒç¾¤ç»„æ•´æ´
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å‚æ•°éªŒè¯å’Œé”™è¯¯æç¤º

## ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤æ ¼å¼

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `,share_plugins` | æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æ’ä»¶åˆ—è¡¨ |
| `,share_plugins <åºå·>` | ç›´æ¥åˆ†äº«æŒ‡å®šåºå·çš„æ’ä»¶ |

### ä½¿ç”¨ç¤ºä¾‹

```bash
# æŸ¥çœ‹æ’ä»¶åˆ—è¡¨
,share_plugins

# è¾“å‡ºç¤ºä¾‹ï¼š
# ğŸ“‹ å¯ç”¨æ’ä»¶åˆ—è¡¨ï¼š
# 1. cai.py
# 2. jpm.py
# 3. example_plugin.py
# ...
#
# ğŸ’¡ è¯·å›å¤å¯¹åº”çš„æ•°å­—åºå·é€‰æ‹©è¦åˆ†äº«çš„æ’ä»¶
# âš ï¸ æ³¨æ„ï¼šæ“ä½œæ¶ˆæ¯ä¼šè¢«æ’¤å›ï¼Œæ’ä»¶æ–‡ä»¶ä¼šç›´æ¥å‘é€åˆ°ç¾¤ç»„

# åˆ†äº«ç¬¬1ä¸ªæ’ä»¶ï¼ˆæ“ä½œæ¶ˆæ¯ä¼šè¢«æ’¤å›ï¼‰
,share_plugins 1

# åˆ†äº«ç¬¬2ä¸ªæ’ä»¶
,share_plugins 2
```

### å·¥ä½œæµç¨‹

```
ç”¨æˆ·å‘é€ ,share_plugins
    â†“
æ˜¾ç¤ºæ’ä»¶åˆ—è¡¨ï¼ˆå¸¦åºå·ï¼‰
    â†“
ç”¨æˆ·è¾“å…¥åºå· ,share_plugins 1
    â†“
æ’¤å›æ“ä½œæ¶ˆæ¯
    â†“
å‘é€æ’ä»¶æ–‡ä»¶åˆ°ç¾¤ç»„
```

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶

#### PluginManager ç±»

è´Ÿè´£æ’ä»¶æ–‡ä»¶çš„æ‰«æå’Œç®¡ç†ï¼š

```python
class PluginManager:
    """æ’ä»¶ç®¡ç†ç±»"""

    def refresh_plugin_list(self):
        """åˆ·æ–°æ’ä»¶åˆ—è¡¨"""
        # æ‰«æ plugins ç›®å½•ï¼Œè·å–æ‰€æœ‰ .py æ–‡ä»¶ï¼ˆæ’é™¤ __ å¼€å¤´çš„æ–‡ä»¶ï¼‰

    def get_plugin_file_path(self, index: int):
        """æ ¹æ®ç´¢å¼•è·å–æ’ä»¶æ–‡ä»¶è·¯å¾„ï¼ˆç´¢å¼•ä»1å¼€å§‹ï¼‰"""

    def format_plugin_list(self) -> str:
        """æ ¼å¼åŒ–æ’ä»¶åˆ—è¡¨ä¸ºå¯è¯»æ–‡æœ¬"""
```

#### å‘½ä»¤å¤„ç†å™¨

å¤„ç† share_plugins å‘½ä»¤ï¼š

```python
@listener(command="share_plugins", description="åˆ†äº«æ’ä»¶", parameters="[åºå·]")
async def share_plugins_command(message: Message, bot: Client):
    # åˆ·æ–°æ’ä»¶åˆ—è¡¨
    # æ£€æŸ¥å‚æ•°
    # æœ‰å‚æ•° â†’ å¤„ç†æ’ä»¶é€‰æ‹©
    # æ— å‚æ•° â†’ æ˜¾ç¤ºæ’ä»¶åˆ—è¡¨
```

#### æ’ä»¶é€‰æ‹©é€»è¾‘

```python
async def handle_plugin_selection(message: Message, bot: Client, args: str):
    # 1. å‚æ•°éªŒè¯ï¼ˆå¿…é¡»æ˜¯æ•°å­—ï¼‰
    # 2. ç´¢å¼•èŒƒå›´æ£€æŸ¥ï¼ˆ1-Nï¼‰
    # 3. æ’¤å›æ“ä½œæ¶ˆæ¯
    # 4. è¯»å–æ’ä»¶æ–‡ä»¶
    # 5. å‘é€åˆ°ç¾¤ç»„
```

### æ¶ˆæ¯æ’¤å›æœºåˆ¶

```python
# æ’¤å›æ“ä½œæ¶ˆæ¯
try:
    await message.delete()
    logs.info(f"[SharePlugins] æ’¤å›æ“ä½œæ¶ˆæ¯: {message.id}")
except Exception as e:
    logs.error(f"[SharePlugins] æ’¤å›æ¶ˆæ¯å¤±è´¥: {e}")
    # å¦‚æœæ’¤å›å¤±è´¥ï¼Œç¼–è¾‘æ¶ˆæ¯å‘ŠçŸ¥ç”¨æˆ·
    await message.edit(f"âš ï¸ æ’¤å›æ¶ˆæ¯å¤±è´¥: {e}")
    return
```

### æ–‡ä»¶å‘é€å®ç°

```python
# è¯»å–æ’ä»¶æ–‡ä»¶
with open(plugin_file, "rb") as f:
    file_content = f.read()

# ä½¿ç”¨ bot å®ä¾‹å‘é€æ–‡ä»¶åˆ°å½“å‰èŠå¤©
await bot.send_document(
    chat_id=message.chat.id,
    document=file_content,
    filename=plugin_file.name,
    caption=f"ğŸ“¦ åˆ†äº«æ’ä»¶: `{plugin_file.name}`",
)
```

### å‚æ•°éªŒè¯

```python
try:
    plugin_index = int(args)
except ValueError:
    await message.edit(f"âŒ æ— æ•ˆçš„åºå·ï¼š`{args}`\nè¯·è¾“å…¥çº¯æ•°å­—åºå·")
    return

# èŒƒå›´æ£€æŸ¥
if 1 <= plugin_index <= len(plugin_list):
    # æœ‰æ•ˆç´¢å¼•
else:
    # ç´¢å¼•è¶…å‡ºèŒƒå›´
```

## é”™è¯¯å¤„ç†

| é”™è¯¯ç±»å‹ | å¤„ç†æ–¹å¼ |
|---------|---------|
| æ— æ•°å­—è¾“å…¥ | æç¤º"è¯·è¾“å…¥çº¯æ•°å­—åºå·" |
| åºå·è¶…å‡ºèŒƒå›´ | æç¤ºæœ‰æ•ˆèŒƒå›´ï¼ˆ1-Nï¼‰ |
| æ’¤å›å¤±è´¥ | ç¼–è¾‘æ¶ˆæ¯æç¤ºé”™è¯¯ï¼Œä¸ç»§ç»­å‘é€ |
| æ–‡ä»¶ä¸å­˜åœ¨ | å‘é€æ–°æ¶ˆæ¯å‘ŠçŸ¥ç”¨æˆ· |
| å‘é€å¤±è´¥ | å‘é€æ–°æ¶ˆæ¯æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ |

## æ³¨æ„äº‹é¡¹

### æ’ä»¶æ‰«æè§„åˆ™

- åªæ‰«æ `plugins/` ç›®å½•
- åªåŒ…å« `.py` æ‰©å±•åçš„æ–‡ä»¶
- æ’é™¤ä»¥ `__` å¼€å¤´çš„æ–‡ä»¶ï¼ˆå¦‚ `__pycache__`ï¼‰
- æ¯æ¬¡å‘½ä»¤æ‰§è¡Œæ—¶åˆ·æ–°åˆ—è¡¨ï¼ˆè·å–æœ€æ–°çŠ¶æ€ï¼‰

### æ¶ˆæ¯æ’¤å›è¯´æ˜

- æ“ä½œæ¶ˆæ¯ä¼šåœ¨å‘é€æ–‡ä»¶å‰è¢«æ’¤å›
- å¦‚æœæ’¤å›å¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰ï¼Œä¼šæç¤ºé”™è¯¯ä¿¡æ¯
- æ’¤å›å¤±è´¥æ—¶ä¼šåœæ­¢åç»­æ“ä½œï¼Œä¸ä¼šé‡å¤å‘é€æ¶ˆæ¯

### æ–‡ä»¶å‘é€è¯´æ˜

- æ’ä»¶æ–‡ä»¶ä»¥æ–‡æ¡£å½¢å¼å‘é€ï¼ˆ`.py` æ–‡ä»¶ï¼‰
- æ–‡ä»¶åä¿æŒåŸæ’ä»¶æ–‡ä»¶å
- è‡ªåŠ¨æ·»åŠ åˆ†äº«è¯´æ˜æ–‡å­—

### ç¾¤ç»„æƒé™è¦æ±‚

- éœ€è¦æœ‰æ’¤å›æ¶ˆæ¯çš„æƒé™
- éœ€è¦æœ‰å‘é€æ–‡æ¡£çš„æƒé™
- å»ºè®®åœ¨ç§å¯†ç¾¤ç»„ä¸­ä½¿ç”¨ï¼ˆé¿å…æ’ä»¶æ–‡ä»¶æ³„éœ²ï¼‰

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæ’ä»¶åˆ—è¡¨ä¸­æ²¡æœ‰æˆ‘çš„æ’ä»¶ï¼Ÿ

**A:** è¯·æ£€æŸ¥ï¼š
1. æ’ä»¶æ–‡ä»¶æ˜¯å¦åœ¨ `plugins/` ç›®å½•ä¸‹
2. æ’ä»¶æ–‡ä»¶æ˜¯å¦æ˜¯ `.py` æ‰©å±•å
3. æ’ä»¶æ–‡ä»¶åæ˜¯å¦ä»¥ `__` å¼€å¤´

### Q: æ’¤å›æ¶ˆæ¯å¤±è´¥æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ

**A:** å¯èƒ½çš„åŸå› ï¼š
1. æ²¡æœ‰æ’¤å›æ¶ˆæ¯çš„æƒé™
2. æ¶ˆæ¯å‘é€æ—¶é—´è¿‡é•¿ï¼ˆè¶…è¿‡ 48 å°æ—¶ï¼‰
3. ç¾¤ç»„é…ç½®é™åˆ¶æ’¤å›æƒé™

### Q: å¦‚ä½•åªæŸ¥çœ‹åˆ—è¡¨ä¸å‘é€æ–‡ä»¶ï¼Ÿ

**A:** ä½¿ç”¨ `,share_plugins` å‘½ä»¤ï¼ˆä¸åŠ å‚æ•°ï¼‰ï¼Œä¼šæ˜¾ç¤ºæ’ä»¶åˆ—è¡¨ä½†ä¸ä¼šå‘é€ä»»ä½•æ–‡ä»¶ã€‚

### Q: åˆ†äº«çš„æ–‡ä»¶èƒ½å¦è¢«ç¼–è¾‘ï¼Ÿ

**A:** æ–‡æ¡£ç±»å‹çš„æ–‡ä»¶å‘é€åæ— æ³•ç¼–è¾‘ï¼Œåªèƒ½åˆ é™¤åé‡æ–°å‘é€ã€‚

## æŠ€æœ¯è¦ç‚¹

### ç´¢å¼•ä» 1 å¼€å§‹

```python
# ç”¨æˆ·è¾“å…¥ï¼š1, 2, 3, ...
# åˆ—è¡¨ç´¢å¼•ï¼š0, 1, 2, ...

# è½¬æ¢é€»è¾‘
plugin_name = plugin_list[plugin_index - 1]  # å‡1è½¬æ¢ä¸º0-based
```

### Bot å‚æ•°æ³¨å…¥

```python
async def share_plugins_command(message: Message, bot: Client):
    # bot å‚æ•°ç”± PagerMaid-Pyro è‡ªåŠ¨æ³¨å…¥
    # ç”¨äºç›´æ¥è°ƒç”¨ Telegram APIï¼ˆå¦‚ send_documentï¼‰
```

### å¼‚å¸¸å¤„ç†åŸåˆ™

```python
try:
    # æ ¸å¿ƒæ“ä½œ
    await message.delete()
except Exception as e:
    logs.error(f"æ“ä½œå¤±è´¥: {e}")
    # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ç¼–è¾‘æ¶ˆæ¯å‘ŠçŸ¥ç”¨æˆ·
    await message.edit(f"æ“ä½œå¤±è´¥: {e}")
```

## æ‰©å±•å»ºè®®

### å¯èƒ½çš„æ”¹è¿›æ–¹å‘

1. **æ’ä»¶é¢„è§ˆ**ï¼šæ˜¾ç¤ºæ’ä»¶æ–‡ä»¶çš„è¡Œæ•°ã€æœ€åä¿®æ”¹æ—¶é—´ç­‰ä¿¡æ¯
2. **æ‰¹é‡åˆ†äº«**ï¼šæ”¯æŒä¸€æ¬¡åˆ†äº«å¤šä¸ªæ’ä»¶ï¼ˆå¦‚ `,share_plugins 1,2,3`ï¼‰
3. **å‹ç¼©æ‰“åŒ…**ï¼šå°†å¤šä¸ªæ’ä»¶æ‰“åŒ…ä¸º `.zip` æ–‡ä»¶å‘é€
4. **æ’ä»¶æœç´¢**ï¼šæ”¯æŒæŒ‰å…³é”®è¯æœç´¢æ’ä»¶
5. **åˆ†ç±»æ˜¾ç¤º**ï¼šæŒ‰æ’ä»¶ç±»å‹åˆ†ç±»æ˜¾ç¤ºï¼ˆç®¡ç†ã€å¨±ä¹ã€å·¥å…·ç­‰ï¼‰

### ç¤ºä¾‹æ‰©å±•ä»£ç 

```python
# æ’ä»¶è¯¦ç»†ä¿¡æ¯
def get_plugin_info(plugin_path: Path) -> dict:
    stat = plugin_path.stat()
    with open(plugin_path, "r", encoding="utf-8") as f:
        lines = len(f.readlines())
    return {
        "name": plugin_path.name,
        "size": f"{stat.st_size / 1024:.1f} KB",
        "lines": lines,
        "modified": stat.st_mtime
    }

# æ‰¹é‡åˆ†äº«
async def handle_batch_selection(message: Message, bot: Client, args: str):
    indices = [int(x) for x in args.split(",")]
    for index in indices:
        await share_single_plugin(message, bot, index)
        await asyncio.sleep(0.5)  # é¿å…é¢‘ç‡é™åˆ¶
```

## ç‰ˆæœ¬å†å²

### v1.0.0 (2025-01-19)
- åˆå§‹ç‰ˆæœ¬
- æ”¯æŒæ’ä»¶åˆ—è¡¨æŸ¥çœ‹
- æ”¯æŒåºå·é€‰æ‹©æ’ä»¶
- æ”¯æŒæ¶ˆæ¯è‡ªåŠ¨æ’¤å›
- æ”¯æŒæ’ä»¶æ–‡ä»¶å‘é€
- å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
