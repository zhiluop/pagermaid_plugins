# JPM 插件

## 版本历史

- **v1.3** - 新增锚点消息功能，自动记录目标用户发言，解决长时间未发言无法回复的问题
- **v1.2** - 更新模板内容，使用 sao_nkr 最新发癫文案（单人21条 + 双人20条）
- **v1.1** - 使用 sao_nkr 发癫文案替换模板（单人16条 + 双人15条）
- **v1.0** - 初始版本，多关键词支持、独立频率限制

## 功能介绍

JPM 是一个基于 PagerMaid-Pyro 的关键词触发回复插件，支持多关键词配置、独立频率限制和灵活的目标回复。

**模板来源：** 使用 sao_nkr 插件的发癫风格文案，包含单人独白和双人互动两种模式。

## 主要特性

- **多关键词配置** - 支持为不同关键词设置不同的目标用户和群组
- **自定义触发词** - 通过 `/关键词` 格式触发回复
- **独立频率限制** - 每个关键词单独计算频率限制时间
- **主人特权** - 主人触发不受任何频率限制
- **共享模板池** - 所有关键词使用统一的回复模板池
- **锚点消息系统** - 自动记录目标用户发言，即使长时间未发言也能回复

## 使用方法

### 配置插件

1. **设置关键词配置**：
   ```
   ,jpm set <关键词> <用户ID> <群组ID> [秒数]
   ```

2. **设置主人ID**（可选）：
   ```
   ,jpm owner <你的Telegram用户ID>
   ```

3. **开启功能**：
   ```
   ,jpm on
   ```

4. **查看状态**：
   ```
   ,jpm status
   ```

### 触发方式

在群组中发送 `/关键词`，支持两种模式：

**单人模式** - 直接发送关键词：
- `/hello` - 触发单人回复模板

**双人模式** - 回复某人 或 带参数：
- `/hello` + 回复某人 → 触发双人互动模板
- `/hello 张三` → 触发双人互动模板（参数作为第二个人名）

### 管理命令

| 命令 | 说明 |
|------|------|
| `,jpm on` | 开启全局功能 |
| `,jpm off` | 关闭全局功能 |
| `,jpm set <关键词> <用户ID> <群组ID> [秒数]` | 添加/更新关键词配置 |
| `,jpm delete <关键词>` | 删除关键词配置 |
| `,jpm list` | 列出所有关键词配置 |
| `,jpm owner <用户ID>` | 设置主人ID |
| `,jpm status` | 查看当前状态 |
| `,jpm anchor set <关键词> [消息ID]` | 手动设置锚点消息 |
| `,jpm anchor clear <关键词>` | 清除锚点消息 |

### 锚点消息管理

**自动记录**：
- 插件会自动监听目标用户的发言并更新锚点消息
- 无需手动操作，确保目标用户每次发言后锚点都会更新

**手动设置**（可选）：
- 回复一条消息后发送：`,jpm anchor set <关键词>`
- 或直接指定消息ID：`,jpm anchor set <关键词> <消息ID>`

**清除锚点**：
- 发送：`,jpm anchor clear <关键词>`

## 文件结构

```
plugins/
├── jpm.py                   # 插件主文件
├── jpm_config.json          # 配置文件（自动生成）
└── jpm_trigger_log.json     # 触发记录（自动生成）
```

## 技术实现

### 核心技术点

- 使用 `listener` 监听群组消息
- 支持关键词匹配触发命令
- 每个关键词独立频率限制
- 配置数据持久化存储为 JSON
- 锚点消息自动追踪和更新

### 锚点消息工作原理

1. **自动追踪**：插件监听所有群组消息，当检测到目标用户发言时，自动更新锚点消息ID
2. **优先级机制**：回复时优先使用锚点消息，如果锚点消息无效则回退到搜索历史消息
3. **持久化存储**：锚点消息ID保存在配置文件中，重启后依然有效

### 数据结构

#### jpm_config.json
```json
{
  "enabled": true,
  "owner_id": 123456789,
  "keywords": {
    "hello": {
      "target_user_id": 987654321,
      "target_chat_id": -1001234567890,
      "rate_limit_seconds": 3600,
      "anchor_message_id": 12345
    }
  }
}
```

## 注意事项

1. 主人ID为可选配置，不设置时所有人都受频率限制
2. 回复优先使用锚点消息，确保即使目标用户长时间未发言也能回复
3. 锚点消息会在目标用户每次发言时自动更新
4. 确保在正确的群组中使用触发命令
5. 触发命令的消息会在发送后被自动删除
